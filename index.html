<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPS Constellation - Retirement Planning Reimagined</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-young: #00d4ff;
            --primary-mid: #ff6b35;
            --primary-mature: #ffd700;
            --bg-gradient-start: #0a0e27;
            --bg-gradient-end: #1a1f3a;
            --card-bg: rgba(255, 255, 255, 0.05);
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff4444;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Animated Background Stars */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 40px 20px;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 3em;
            background: linear-gradient(135deg, var(--primary-young), var(--primary-mature));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { filter: drop-shadow(0 0 10px rgba(0, 212, 255, 0.5)); }
            50% { filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.8)); }
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.2em;
        }

        /* Life Stage Indicator */
        .life-stage {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .stage-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            border-radius: 15px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .stage-card.active {
            border-color: var(--primary-young);
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.3);
        }

        .stage-card:hover {
            transform: translateY(-5px);
        }

        /* Input Section */
        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .input-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1.1em;
            transition: all 0.3s ease;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--primary-young);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }

        /* Calculate Button */
        .calculate-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--primary-young), var(--primary-mid));
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .calculate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.4);
        }

        /* Results Section */
        .results-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Constellation Visualization */
        .constellation {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        #constellationCanvas {
            width: 100%;
            height: 400px;
            border-radius: 15px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(135deg, var(--primary-young), var(--primary-mature));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 10px 0;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Probability Distribution */
        .probability-section {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .probability-section h2 {
            margin-bottom: 20px;
            text-align: center;
        }

        /* NPS Breakdown */
        .nps-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .breakdown-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .breakdown-card h3 {
            margin-bottom: 15px;
            color: var(--primary-young);
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .breakdown-item:last-child {
            border-bottom: none;
        }

        /* AI Insights */
        .ai-insights {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(255, 107, 53, 0.1));
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .ai-insights h2 {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-icon {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .insight-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-young);
        }

        /* Regret Visualizer */
        .regret-visualizer {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .regret-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .regret-card {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .regret-card.missed {
            border: 2px solid var(--danger);
        }

        .regret-card.current {
            border: 2px solid var(--success);
        }

        /* Achievements */
        .achievements {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 30px 0;
        }

        .achievement-badge {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            padding: 15px 25px;
            border-radius: 50px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .achievement-badge.unlocked {
            border-color: var(--success);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .achievement-badge:hover {
            transform: scale(1.05);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .input-section {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Scenario Comparison */
        .scenario-comparison {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .scenario-cards {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 30px;
            margin-bottom: 30px;
            align-items: stretch;
        }

        .scenario-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid;
            transition: all 0.3s ease;
        }

        .scenario-card.existing {
            border-color: var(--warning);
        }

        .scenario-card.optimized {
            border-color: var(--success);
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.2);
        }

        .scenario-card:hover {
            transform: translateY(-5px);
        }

        .scenario-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .scenario-header h3 {
            margin-bottom: 8px;
        }

        .scenario-header p {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .scenario-divider {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .vs-badge {
            background: linear-gradient(135deg, var(--primary-young), var(--primary-mature));
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
            animation: pulse 2s infinite;
        }

        .comparison-arrow {
            font-size: 2em;
            color: var(--success);
            animation: slideRight 1.5s infinite;
        }

        @keyframes slideRight {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(10px); }
        }

        .scenario-stat-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .scenario-stat-item:last-child {
            border-bottom: none;
        }

        .scenario-stat-value {
            font-weight: bold;
            font-size: 1.1em;
        }

        .scenario-impact {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 212, 255, 0.1));
            padding: 25px;
            border-radius: 15px;
            border: 2px solid var(--success);
        }

        .impact-highlight {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--success);
            text-align: center;
            margin: 15px 0;
        }

        /* Asset Allocation Timeline */
        .asset-allocation-timeline {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        @media (max-width: 968px) {
            .scenario-cards {
                grid-template-columns: 1fr;
            }

            .scenario-divider {
                flex-direction: row;
            }

            .comparison-arrow {
                transform: rotate(90deg);
            }
        }

        /* Loading Animation */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary-young);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Animated Stars Background -->
    <div class="stars" id="starsContainer"></div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üåü NPS CONSTELLATION</h1>
            <p>Your Retirement Journey, Visualized Through Space & Time</p>
        </div>

        <!-- Life Stage Selector -->
        <div class="life-stage">
            <div class="stage-card active" data-stage="young">
                <h3>üöÄ Early Career</h3>
                <p>Age 20-30</p>
            </div>
            <div class="stage-card" data-stage="mid">
                <h3>‚õ∞Ô∏è Mid Career</h3>
                <p>Age 31-45</p>
            </div>
            <div class="stage-card" data-stage="mature">
                <h3>üåÖ Pre-Retirement</h3>
                <p>Age 46-60</p>
            </div>
        </div>

        <!-- Input Section -->
        <div class="input-section">
            <div class="input-card">
                <h2>üìä Your Profile</h2>
                <div class="input-group">
                    <label>Current Age</label>
                    <input type="number" id="currentAge" value="30" min="18" max="60">
                </div>
                <div class="input-group">
                    <label>Retirement Age</label>
                    <input type="number" id="retirementAge" value="60" min="50" max="70">
                </div>
                <div class="input-group">
                    <label>Current Annual Income (‚Çπ)</label>
                    <input type="number" id="currentIncome" value="600000" step="50000">
                </div>
            </div>

            <div class="input-card">
                <h2>üí∞ NPS Contributions</h2>
                <div class="input-group">
                    <label>NPS Tier</label>
                    <select id="npsTier">
                        <option value="tier1">Tier I (Tax Benefits)</option>
                        <option value="tier2">Tier II (Flexible Withdrawal)</option>
                        <option value="both">Both Tiers</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Monthly Contribution (‚Çπ)</label>
                    <input type="number" id="monthlyContribution" value="5000" step="500">
                </div>
                <div class="input-group">
                    <label>Employer Contribution (‚Çπ)</label>
                    <input type="number" id="employerContribution" value="5000" step="500">
                </div>
            </div>

            <div class="input-card">
                <h2>üìà Investment Strategy</h2>
                <div class="input-group">
                    <label>Risk Profile</label>
                    <select id="riskProfile" onchange="updateRiskProfile()">
                        <option value="conservative">Conservative (Safe, Lower Returns)</option>
                        <option value="moderate" selected>Moderate (Balanced)</option>
                        <option value="aggressive">Aggressive (High Growth, Higher Risk)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Expected Annual Return (%)</label>
                    <input type="number" id="expectedReturn" value="10" step="0.5" min="5" max="15" readonly style="background: rgba(255, 255, 255, 0.1);">
                </div>
                <div class="input-group">
                    <label>Current NPS Corpus (‚Çπ)</label>
                    <input type="number" id="currentCorpus" value="0" step="10000" placeholder="Existing NPS value">
                </div>
            </div>

            <div class="input-card">
                <h2>üéØ Additional Parameters</h2>
                <div class="input-group">
                    <label>Annual Salary Increment (%)</label>
                    <input type="number" id="salaryIncrement" value="7" step="0.5" min="0" max="20">
                </div>
                <div class="input-group">
                    <label>Inflation Rate (%)</label>
                    <input type="number" id="inflationRate" value="6" step="0.5" min="3" max="10">
                </div>
                <div class="input-group">
                    <label>Annual Step-up in Contribution (%)</label>
                    <input type="number" id="contributionStepUp" value="0" step="5" min="0" max="50" placeholder="Optional: Increase yearly">
                </div>
            </div>
        </div>

        <button class="calculate-btn" onclick="calculateRetirement()">
            üöÄ Launch Your Retirement Simulation
        </button>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <!-- Achievements -->
            <div class="achievements" id="achievements"></div>

            <!-- Scenario Comparison -->
            <div class="scenario-comparison" id="scenarioComparison" style="display: none;">
                <h2 style="text-align: center; margin-bottom: 30px;">üìä Scenario Analysis: Existing vs Optimized</h2>
                <div class="scenario-cards">
                    <div class="scenario-card existing">
                        <div class="scenario-header">
                            <h3>üìâ Current Trajectory</h3>
                            <p>Maintaining current contributions</p>
                        </div>
                        <div id="existingScenarioStats"></div>
                    </div>
                    <div class="scenario-divider">
                        <div class="vs-badge">VS</div>
                        <div class="comparison-arrow">‚Üí</div>
                    </div>
                    <div class="scenario-card optimized">
                        <div class="scenario-header">
                            <h3>üìà Optimized Strategy</h3>
                            <p>With enhanced contributions</p>
                        </div>
                        <div id="optimizedScenarioStats"></div>
                    </div>
                </div>
                <div class="scenario-impact" id="scenarioImpact"></div>
            </div>

            <!-- Constellation Visualization -->
            <div class="constellation">
                <h2 style="text-align: center; margin-bottom: 20px;">Your Retirement Constellation</h2>
                <canvas id="constellationCanvas"></canvas>
                <div id="riskIndicator" style="text-align: center; margin-top: 20px; color: var(--text-secondary);"></div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid" id="statsGrid"></div>

            <!-- Asset Allocation Timeline -->
            <div class="asset-allocation-timeline">
                <h2 style="text-align: center; margin-bottom: 20px;">üéØ Dynamic Asset Allocation Strategy</h2>
                <p style="text-align: center; color: var(--text-secondary); margin-bottom: 30px;">
                    Your portfolio automatically rebalances as you age, reducing risk near retirement
                </p>
                <canvas id="assetAllocationChart"></canvas>
            </div>

            <!-- Probability Distribution -->
            <div class="probability-section">
                <h2>Monte Carlo Simulation - Probability Distribution</h2>
                <canvas id="probabilityChart"></canvas>
            </div>

            <!-- NPS Breakdown -->
            <div class="nps-breakdown" id="npsBreakdown"></div>

            <!-- Regret Visualizer -->
            <div class="regret-visualizer">
                <h2>‚è∞ The Regret Visualizer</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    What if you had started earlier? Here's what you missed...
                </p>
                <div class="regret-comparison" id="regretComparison"></div>
            </div>

            <!-- AI Insights -->
            <div class="ai-insights">
                <h2>
                    <span class="ai-icon">ü§ñ</span>
                    AI-Powered Insights
                </h2>
                <div id="aiInsights"></div>
            </div>
        </div>
    </div>

    <script>
        // Create animated stars
        function createStars() {
            const container = document.getElementById('starsContainer');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = star.style.height = Math.random() * 3 + 'px';
                star.style.animationDelay = Math.random() * 3 + 's';
                container.appendChild(star);
            }
        }

        createStars();

        // Risk profile configurations
        const riskProfiles = {
            conservative: {
                name: 'Conservative',
                expectedReturn: 8.5,
                volatility: 8,
                equityAllocation: 0.3,
                debtAllocation: 0.65,
                alternativeAllocation: 0.05,
                description: 'Low risk, stable returns. Suitable for risk-averse investors.'
            },
            moderate: {
                name: 'Moderate',
                expectedReturn: 10,
                volatility: 12,
                equityAllocation: 0.5,
                debtAllocation: 0.45,
                alternativeAllocation: 0.05,
                description: 'Balanced risk-reward. Suitable for most investors.'
            },
            aggressive: {
                name: 'Aggressive',
                expectedReturn: 12,
                volatility: 18,
                equityAllocation: 0.75,
                debtAllocation: 0.20,
                alternativeAllocation: 0.05,
                description: 'High risk, high returns. Suitable for young investors with long horizon.'
            }
        };

        // Update risk profile dynamically
        function updateRiskProfile() {
            const profile = document.getElementById('riskProfile').value;
            const config = riskProfiles[profile];
            document.getElementById('expectedReturn').value = config.expectedReturn;
        }

        // Calculate age-based asset allocation (glide path)
        function calculateAssetAllocation(currentAge, retirementAge, riskProfile) {
            const years = retirementAge - currentAge;
            const allocation = [];
            const baseProfile = riskProfiles[riskProfile];
            
            for (let age = currentAge; age <= retirementAge; age++) {
                const yearsToRetirement = retirementAge - age;
                const riskFactor = yearsToRetirement / years;
                
                // Glide path: reduce equity as retirement approaches
                const equity = baseProfile.equityAllocation * (0.4 + 0.6 * riskFactor);
                const debt = 1 - equity - baseProfile.alternativeAllocation;
                
                allocation.push({
                    age: age,
                    equity: equity * 100,
                    debt: debt * 100,
                    alternative: baseProfile.alternativeAllocation * 100
                });
            }
            
            return allocation;
        }

        // Life stage selector
        document.querySelectorAll('.stage-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.stage-card').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                updateTheme(this.dataset.stage);
            });
        });

        function updateTheme(stage) {
            const root = document.documentElement;
            if (stage === 'young') {
                root.style.setProperty('--primary-young', '#00d4ff');
                root.style.setProperty('--bg-gradient-start', '#0a0e27');
            } else if (stage === 'mid') {
                root.style.setProperty('--primary-young', '#ff6b35');
                root.style.setProperty('--bg-gradient-start', '#2a1a0e');
            } else {
                root.style.setProperty('--primary-young', '#ffd700');
                root.style.setProperty('--bg-gradient-start', '#1a1410');
            }
        }

        // Enhanced Monte Carlo Simulation with Dynamic Asset Allocation
        function runMonteCarloSimulation(params, iterations = 1000) {
            const results = [];
            const { years, monthlyTotal, annualReturn, volatility, currentCorpus, contributionStepUp, riskProfile, currentAge, retirementAge } = params;
            
            for (let i = 0; i < iterations; i++) {
                let corpus = currentCorpus || 0;
                let monthly = monthlyTotal;
                
                for (let year = 0; year < years; year++) {
                    const age = currentAge + year;
                    const yearsToRetirement = retirementAge - age;
                    
                    // Dynamic asset allocation based on age (glide path)
                    const riskFactor = Math.max(0.3, yearsToRetirement / years);
                    const adjustedReturn = annualReturn * (0.7 + 0.3 * riskFactor);
                    const adjustedVolatility = volatility * riskFactor;
                    
                    for (let month = 0; month < 12; month++) {
                        // Add monthly contribution
                        corpus += monthly;
                        
                        // Generate random return using Box-Muller transform for normal distribution
                        const u1 = Math.random();
                        const u2 = Math.random();
                        const z = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
                        
                        // Monthly return with volatility
                        const monthlyReturn = (adjustedReturn / 100 / 12) + 
                            z * (adjustedVolatility / 100 / Math.sqrt(12));
                        
                        // Apply return
                        corpus *= (1 + monthlyReturn);
                    }
                    
                    // Annual contribution step-up
                    if (contributionStepUp > 0) {
                        monthly *= (1 + contributionStepUp / 100);
                    } else {
                        monthly *= (1 + params.salaryIncrement / 100);
                    }
                }
                
                results.push(Math.max(0, corpus)); // Ensure no negative values
            }
            
            return results.sort((a, b) => a - b);
        }

        // Calculate retirement with two scenarios
        function calculateRetirement() {
            // Get input values
            const currentAge = parseInt(document.getElementById('currentAge').value);
            const retirementAge = parseInt(document.getElementById('retirementAge').value);
            const currentIncome = parseFloat(document.getElementById('currentIncome').value);
            const monthlyContribution = parseFloat(document.getElementById('monthlyContribution').value);
            const employerContribution = parseFloat(document.getElementById('employerContribution').value);
            const expectedReturn = parseFloat(document.getElementById('expectedReturn').value);
            const salaryIncrement = parseFloat(document.getElementById('salaryIncrement').value);
            const inflationRate = parseFloat(document.getElementById('inflationRate').value);
            const npsTier = document.getElementById('npsTier').value;
            const riskProfile = document.getElementById('riskProfile').value;
            const currentCorpus = parseFloat(document.getElementById('currentCorpus').value) || 0;
            const contributionStepUp = parseFloat(document.getElementById('contributionStepUp').value) || 0;

            const years = retirementAge - currentAge;
            const monthlyTotal = monthlyContribution + employerContribution;
            const volatility = riskProfiles[riskProfile].volatility;

            // SCENARIO 1: Existing (Current trajectory)
            const existingParams = {
                years,
                monthlyTotal,
                annualReturn: expectedReturn,
                volatility,
                salaryIncrement,
                currentCorpus,
                contributionStepUp: 0, // No step-up in existing scenario
                riskProfile,
                currentAge,
                retirementAge
            };
            const existingResults = runMonteCarloSimulation(existingParams);

            // SCENARIO 2: Optimized (20% increase + step-up)
            const optimizedMonthly = monthlyTotal * 1.2;
            const optimizedParams = {
                years,
                monthlyTotal: optimizedMonthly,
                annualReturn: expectedReturn,
                volatility,
                salaryIncrement,
                currentCorpus,
                contributionStepUp: Math.max(contributionStepUp, 5), // Minimum 5% step-up
                riskProfile,
                currentAge,
                retirementAge
            };
            const optimizedResults = runMonteCarloSimulation(optimizedParams);

            // Calculate percentiles for both scenarios
            const existingP10 = existingResults[Math.floor(existingResults.length * 0.1)];
            const existingP50 = existingResults[Math.floor(existingResults.length * 0.5)];
            const existingP90 = existingResults[Math.floor(existingResults.length * 0.9)];

            const optimizedP10 = optimizedResults[Math.floor(optimizedResults.length * 0.1)];
            const optimizedP50 = optimizedResults[Math.floor(optimizedResults.length * 0.5)];
            const optimizedP90 = optimizedResults[Math.floor(optimizedResults.length * 0.9)];

            // Calculate total contributions for both scenarios
            let existingTotalContributions = currentCorpus;
            let optimizedTotalContributions = currentCorpus;
            let existingMonthly = monthlyTotal;
            let optimizedMonthly2 = optimizedMonthly;

            for (let year = 0; year < years; year++) {
                existingTotalContributions += existingMonthly * 12;
                optimizedTotalContributions += optimizedMonthly2 * 12;
                
                existingMonthly *= (1 + salaryIncrement / 100);
                optimizedMonthly2 *= (1 + Math.max(contributionStepUp, 5) / 100);
            }

            // NPS specific calculations for both scenarios
            const existingLumpSum = existingP50 * 0.6;
            const existingAnnuityCorpus = existingP50 * 0.4;
            const existingMonthlyPension = (existingAnnuityCorpus * 0.06) / 12;

            const optimizedLumpSum = optimizedP50 * 0.6;
            const optimizedAnnuityCorpus = optimizedP50 * 0.4;
            const optimizedMonthlyPension = (optimizedAnnuityCorpus * 0.06) / 12;
            
            // Tax benefits
            const existingAnnualTaxSaving = Math.min(monthlyTotal * 12, 200000) * 0.3;
            const optimizedAnnualTaxSaving = Math.min(optimizedMonthly * 12, 200000) * 0.3;
            const existingTotalTaxSavings = existingAnnualTaxSaving * years;
            const optimizedTotalTaxSavings = optimizedAnnualTaxSaving * years;

            // Calculate asset allocation timeline
            const assetAllocation = calculateAssetAllocation(currentAge, retirementAge, riskProfile);

            // Display results
            displayResults({
                existing: {
                    p10: existingP10,
                    p50: existingP50,
                    p90: existingP90,
                    totalContributions: existingTotalContributions,
                    lumpSum: existingLumpSum,
                    annuityCorpus: existingAnnuityCorpus,
                    monthlyPension: existingMonthlyPension,
                    totalTaxSavings: existingTotalTaxSavings,
                    simResults: existingResults
                },
                optimized: {
                    p10: optimizedP10,
                    p50: optimizedP50,
                    p90: optimizedP90,
                    totalContributions: optimizedTotalContributions,
                    lumpSum: optimizedLumpSum,
                    annuityCorpus: optimizedAnnuityCorpus,
                    monthlyPension: optimizedMonthlyPension,
                    totalTaxSavings: optimizedTotalTaxSavings,
                    simResults: optimizedResults
                },
                years,
                currentAge,
                retirementAge,
                monthlyTotal,
                optimizedMonthly,
                inflationRate,
                currentCorpus,
                riskProfile,
                assetAllocation
            });
        }

        function displayResults(data) {
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });

            // Format currency
            const formatCurrency = (amount) => {
                if (amount >= 10000000) {
                    return '‚Çπ' + (amount / 10000000).toFixed(2) + ' Cr';
                } else if (amount >= 100000) {
                    return '‚Çπ' + (amount / 100000).toFixed(2) + ' L';
                } else {
                    return '‚Çπ' + amount.toLocaleString('en-IN');
                }
            };

            // Display Scenario Comparison
            const scenarioComparison = document.getElementById('scenarioComparison');
            scenarioComparison.style.display = 'block';

            // Existing Scenario Stats
            document.getElementById('existingScenarioStats').innerHTML = `
                <div class="scenario-stat-item">
                    <span>Expected Corpus</span>
                    <span class="scenario-stat-value">${formatCurrency(data.existing.p50)}</span>
                </div>
                <div class="scenario-stat-item">
                    <span>Monthly Pension</span>
                    <span class="scenario-stat-value">${formatCurrency(data.existing.monthlyPension)}</span>
                </div>
                <div class="scenario-stat-item">
                    <span>Lump Sum (60%)</span>
                    <span class="scenario-stat-value">${formatCurrency(data.existing.lumpSum)}</span>
                </div>
                <div class="scenario-stat-item">
                    <span>Total Contributions</span>
                    <span class="scenario-stat-value">${formatCurrency(data.existing.totalContributions)}</span>
                </div>
                <div class="scenario-stat-item">
                    <span>Wealth Multiplier</span>
                    <span class="scenario-stat-value">${(data.existing.p50 / data.existing.totalContributions).toFixed(2)}x</span>
                </div>
            `;

            // Optimized Scenario Stats
            document.getElementById('optimizedScenarioStats').innerHTML = `
                <div class="scenario-stat-item">
                    <span>Expected Corpus</span>
                    <span class="scenario-stat-value" style="color: var(--success);">${formatCurrency(data.optimized.p50)}</span>
                </div>
                <div class="scenario-stat-item">
                    <span>Monthly Pension</span>
                    <span class="scenario-stat-value" style="color: var(--success);">${formatCurrency(data.optimized.monthlyPension)}</span>
                </div>
                <div class="scenario-stat-item">
                    <span>Lump Sum (60%)</span>
                    <span class="scenario-stat-value" style="color: var(--success);">${formatCurrency(data.optimized.lumpSum)}</span>
                </div>
                <div class="scenario-stat-item">
                    <span>Total Contributions</span>
                    <span class="scenario-stat-value" style="color: var(--success);">${formatCurrency(data.optimized.totalContributions)}</span>
                </div>
                <div class="scenario-stat-item">
                    <span>Wealth Multiplier</span>
                    <span class="scenario-stat-value" style="color: var(--success);">${(data.optimized.p50 / data.optimized.totalContributions).toFixed(2)}x</span>
                </div>
            `;

            // Impact Analysis
            const corpusDiff = data.optimized.p50 - data.existing.p50;
            const pensionDiff = data.optimized.monthlyPension - data.existing.monthlyPension;
            const percentageGain = ((corpusDiff / data.existing.p50) * 100).toFixed(1);
            const extraContribution = data.optimized.totalContributions - data.existing.totalContributions;

            document.getElementById('scenarioImpact').innerHTML = `
                <h3 style="text-align: center; margin-bottom: 15px;">üí° Optimization Impact</h3>
                <div class="impact-highlight">
                    +${formatCurrency(corpusDiff)} (${percentageGain}% increase)
                </div>
                <p style="text-align: center; color: var(--text-secondary);">
                    By increasing contributions by just 20% and maintaining a 5% annual step-up, you gain an extra 
                    <strong style="color: var(--success);">${formatCurrency(corpusDiff)}</strong> at retirement!
                </p>
                <p style="text-align: center; color: var(--text-secondary); margin-top: 15px;">
                    Your monthly pension increases by <strong style="color: var(--success);">${formatCurrency(pensionDiff)}</strong>,
                    requiring only <strong>${formatCurrency(extraContribution)}</strong> in additional contributions over ${data.years} years.
                </p>
                <p style="text-align: center; margin-top: 15px; font-size: 1.1em;">
                    <strong>ROI on extra contribution: ${((corpusDiff / extraContribution) * 100).toFixed(0)}%</strong>
                </p>
            `;

            // Stats Grid (using optimized scenario)
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Expected Corpus (Optimized)</div>
                    <div class="stat-value">${formatCurrency(data.optimized.p50)}</div>
                    <p style="color: var(--text-secondary); margin-top: 10px;">Median outcome with optimization</p>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Conservative (10th %ile)</div>
                    <div class="stat-value">${formatCurrency(data.optimized.p10)}</div>
                    <p style="color: var(--text-secondary); margin-top: 10px;">Worst case scenario</p>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Optimistic (90th %ile)</div>
                    <div class="stat-value">${formatCurrency(data.optimized.p90)}</div>
                    <p style="color: var(--text-secondary); margin-top: 10px;">Best case scenario</p>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Monthly Pension</div>
                    <div class="stat-value">${formatCurrency(data.optimized.monthlyPension)}</div>
                    <p style="color: var(--text-secondary); margin-top: 10px;">From 40% annuity purchase</p>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Tax Savings</div>
                    <div class="stat-value">${formatCurrency(data.optimized.totalTaxSavings)}</div>
                    <p style="color: var(--text-secondary); margin-top: 10px;">80CCD(1B) benefits</p>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Wealth Multiplier</div>
                    <div class="stat-value">${(data.optimized.p50 / data.optimized.totalContributions).toFixed(2)}x</div>
                    <p style="color: var(--text-secondary); margin-top: 10px;">Returns on investment</p>
                </div>
            `;

            // Risk indicator
            const riskConfig = riskProfiles[data.riskProfile];
            document.getElementById('riskIndicator').innerHTML = `
                <strong>Risk Profile: ${riskConfig.name}</strong><br>
                ${riskConfig.description}<br>
                Expected Return: ${riskConfig.expectedReturn}% | Volatility: ${riskConfig.volatility}%
            `;

            // NPS Breakdown (using optimized)
            const npsBreakdown = document.getElementById('npsBreakdown');
            npsBreakdown.innerHTML = `
                <div class="breakdown-card">
                    <h3>üíº Retirement Withdrawal (Age ${data.retirementAge})</h3>
                    <div class="breakdown-item">
                        <span>60% Lump Sum (Tax-Free)</span>
                        <strong>${formatCurrency(data.optimized.lumpSum)}</strong>
                    </div>
                    <div class="breakdown-item">
                        <span>40% Annuity Purchase</span>
                        <strong>${formatCurrency(data.optimized.annuityCorpus)}</strong>
                    </div>
                    <div class="breakdown-item">
                        <span>Monthly Pension (6% rate)</span>
                        <strong>${formatCurrency(data.optimized.monthlyPension)}</strong>
                    </div>
                </div>
                <div class="breakdown-card">
                    <h3>üìä Contribution Analysis</h3>
                    <div class="breakdown-item">
                        <span>Starting Corpus</span>
                        <strong>${formatCurrency(data.currentCorpus)}</strong>
                    </div>
                    <div class="breakdown-item">
                        <span>Total Contributions</span>
                        <strong>${formatCurrency(data.optimized.totalContributions - data.currentCorpus)}</strong>
                    </div>
                    <div class="breakdown-item">
                        <span>Investment Gains</span>
                        <strong>${formatCurrency(data.optimized.p50 - data.optimized.totalContributions)}</strong>
                    </div>
                    <div class="breakdown-item">
                        <span>Tax Savings (30% bracket)</span>
                        <strong>${formatCurrency(data.optimized.totalTaxSavings)}</strong>
                    </div>
                </div>
                <div class="breakdown-card">
                    <h3>üéØ Inflation-Adjusted Values</h3>
                    <div class="breakdown-item">
                        <span>Today's Pension Power</span>
                        <strong>${formatCurrency(data.optimized.monthlyPension / Math.pow(1 + data.inflationRate/100, data.years))}</strong>
                    </div>
                    <div class="breakdown-item">
                        <span>Future Pension Value</span>
                        <strong>${formatCurrency(data.optimized.monthlyPension)}</strong>
                    </div>
                    <div class="breakdown-item">
                        <span>Real Purchasing Power Loss</span>
                        <strong>${((1 - 1/Math.pow(1 + data.inflationRate/100, data.years)) * 100).toFixed(1)}% over ${data.years}y</strong>
                    </div>
                </div>
            `;

            // Regret Visualizer (unchanged, using existing data)
            const regretComparison = document.getElementById('regretComparison');
            const yearsAgo = [1, 3, 5, 10];
            let regretHTML = '';
            
            yearsAgo.forEach(ago => {
                if (data.currentAge - ago >= 18) {
                    const extraYears = ago;
                    const extraCorpus = runMonteCarloSimulation({
                        years: data.years + extraYears,
                        monthlyTotal: data.monthlyTotal,
                        annualReturn: riskProfiles[data.riskProfile].expectedReturn,
                        volatility: riskProfiles[data.riskProfile].volatility,
                        salaryIncrement: 7,
                        currentCorpus: 0,
                        contributionStepUp: 0,
                        riskProfile: data.riskProfile,
                        currentAge: data.currentAge - ago,
                        retirementAge: data.retirementAge
                    });
                    const extraMedian = extraCorpus[Math.floor(extraCorpus.length * 0.5)];
                    const missedGain = extraMedian - data.existing.p50;
                    
                    regretHTML += `
                        <div class="regret-card missed">
                            <h4>${ago} Year${ago > 1 ? 's' : ''} Ago</h4>
                            <p style="font-size: 1.5em; color: var(--danger); margin: 10px 0;">
                                ${formatCurrency(extraMedian)}
                            </p>
                            <p style="color: var(--text-secondary);">
                                Missed: ${formatCurrency(missedGain)}
                            </p>
                        </div>
                    `;
                }
            });
            
            regretHTML += `
                <div class="regret-card current">
                    <h4>Starting Today</h4>
                    <p style="font-size: 1.5em; color: var(--success); margin: 10px 0;">
                        ${formatCurrency(data.existing.p50)}
                    </p>
                    <p style="color: var(--text-secondary);">
                        Your current trajectory
                    </p>
                </div>
            `;
            
            regretComparison.innerHTML = regretHTML;

            // Achievements (based on optimized scenario)
            displayAchievements(data.optimized, data.years, data.optimizedMonthly);

            // AI Insights
            generateAIInsights(data);

            // Draw constellation
            drawConstellation(data.optimized, data.riskProfile);

            // Draw probability chart (comparing both scenarios)
            drawProbabilityChart(data.existing.simResults, data.optimized.simResults);

            // Draw asset allocation chart
            drawAssetAllocationChart(data.assetAllocation);
        }

        function displayAchievements(optimizedData, years, monthlyTotal) {
            const achievements = [];
            
            if (optimizedData.p50 >= 1000000) achievements.push({ icon: 'üèÜ', name: 'First Lakh', unlocked: true });
            if (optimizedData.p50 >= 10000000) achievements.push({ icon: 'üíé', name: 'Crorepati Track', unlocked: true });
            if (years >= 20) achievements.push({ icon: '‚≠ê', name: 'Long-term Planner', unlocked: true });
            if (monthlyTotal >= 10000) achievements.push({ icon: 'üöÄ', name: 'High Contributor', unlocked: true });
            if (optimizedData.p50 / optimizedData.totalContributions >= 3) achievements.push({ icon: 'üìà', name: 'Wealth Multiplier', unlocked: true });
            
            const achievementsHTML = achievements.map(a => `
                <div class="achievement-badge ${a.unlocked ? 'unlocked' : ''}">
                    <span style="font-size: 1.5em;">${a.icon}</span>
                    <span>${a.name}</span>
                </div>
            `).join('');
            
            document.getElementById('achievements').innerHTML = achievementsHTML;
        }

        function generateAIInsights(data) {
            const insights = [];
            const formatCurrency = (amount) => {
                if (amount >= 10000000) return '‚Çπ' + (amount / 10000000).toFixed(2) + ' Cr';
                else if (amount >= 100000) return '‚Çπ' + (amount / 100000).toFixed(2) + ' L';
                else return '‚Çπ' + amount.toLocaleString('en-IN');
            };

            // Insight 1: Optimization impact
            const corpusGain = data.optimized.p50 - data.existing.p50;
            const percentGain = ((corpusGain / data.existing.p50) * 100).toFixed(1);
            insights.push(`
                <div class="insight-item">
                    <strong>üí° Optimization Power:</strong> By adopting the optimized strategy, you can boost 
                    your retirement corpus by ${formatCurrency(corpusGain)} (${percentGain}% increase). 
                    That's an extra ${formatCurrency(data.optimized.monthlyPension - data.existing.monthlyPension)} 
                    per month in pension!
                </div>
            `);

            // Insight 2: Early retirement possibility
            if (data.years > 10) {
                const earlyRetirementYears = Math.floor(Math.log(data.optimized.p50 / data.existing.p50) / Math.log(1.1) * 2);
                if (earlyRetirementYears > 0) {
                    insights.push(`
                        <div class="insight-item">
                            <strong>‚è∞ Early Retirement Potential:</strong> With the optimized strategy, 
                            you could potentially reach your current retirement goal approximately 
                            ${earlyRetirementYears} years earlier, giving you more time to enjoy retirement!
                        </div>
                    `);
                }
            }

            // Insight 3: Tax efficiency
            const taxSavingsDiff = data.optimized.totalTaxSavings - data.existing.totalTaxSavings;
            insights.push(`
                <div class="insight-item">
                    <strong>üí∞ Tax Optimization:</strong> Your optimized NPS contributions will save you an additional 
                    ${formatCurrency(taxSavingsDiff)} in taxes over ${data.years} years compared to your current plan. 
                    That's free money back in your pocket!
                </div>
            `);

            // Insight 4: Risk assessment based on profile
            const riskRange = data.optimized.p90 - data.optimized.p10;
            const riskPercent = (riskRange / data.optimized.p50 * 100).toFixed(0);
            const riskConfig = riskProfiles[data.riskProfile];
            insights.push(`
                <div class="insight-item">
                    <strong>üìä Risk Profile Analysis:</strong> Your ${riskConfig.name} portfolio has a ¬±${riskPercent}% 
                    variance range (${formatCurrency(data.optimized.p10)} to ${formatCurrency(data.optimized.p90)}). 
                    ${riskPercent > 60 ? 'Consider balancing with lower-risk assets as you approach retirement.' : 
                    'Your risk-return profile is well-calibrated for your age and goals.'}
                </div>
            `);

            // Insight 5: Inflation reality check
            const realPension = data.optimized.monthlyPension / Math.pow(1 + data.inflationRate/100, data.years);
            const inflationImpact = ((1 - realPension / data.optimized.monthlyPension) * 100).toFixed(0);
            insights.push(`
                <div class="insight-item">
                    <strong>üéØ Inflation Reality Check:</strong> While your future pension will be 
                    ${formatCurrency(data.optimized.monthlyPension)}, inflation will reduce its real value to 
                    ${formatCurrency(realPension)} in today's money (${inflationImpact}% reduction). 
                    Plan for supplementary income sources or consider higher contributions!
                </div>
            `);

            // Insight 6: Current corpus utilization (if applicable)
            if (data.currentCorpus > 0) {
                const corpusGrowth = data.optimized.p50 - data.currentCorpus;
                const corpusMultiple = (data.optimized.p50 / data.currentCorpus).toFixed(1);
                insights.push(`
                    <div class="insight-item">
                        <strong>üå± Existing Corpus Growth:</strong> Your current NPS balance of 
                        ${formatCurrency(data.currentCorpus)} is projected to grow to 
                        ${formatCurrency(data.optimized.p50)} by retirement ‚Äî a ${corpusMultiple}x increase! 
                        The power of compound interest will add ${formatCurrency(corpusGrowth)} to your nest egg.
                    </div>
                `);
            }

            document.getElementById('aiInsights').innerHTML = insights.join('');
        }

        function drawConstellation(data, riskProfile) {
            const canvas = document.getElementById('constellationCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw probability rings with risk-based colors
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const maxRadius = Math.min(canvas.width, canvas.height) * 0.4;

            const riskConfig = riskProfiles[riskProfile];
            const ringColor = riskProfile === 'conservative' ? 'rgba(0, 255, 136, 0.3)' :
                              riskProfile === 'aggressive' ? 'rgba(255, 68, 68, 0.3)' :
                              'rgba(0, 212, 255, 0.3)';

            // 90% confidence ring
            ctx.beginPath();
            ctx.arc(centerX, centerY, maxRadius, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 2;
            ctx.stroke();

            // 75% confidence ring
            ctx.beginPath();
            ctx.arc(centerX, centerY, maxRadius * 0.7, 0, Math.PI * 2);
            ctx.strokeStyle = ringColor;
            ctx.lineWidth = 2;
            ctx.stroke();

            // 50% confidence ring (median)
            ctx.beginPath();
            ctx.arc(centerX, centerY, maxRadius * 0.5, 0, Math.PI * 2);
            ctx.strokeStyle = ringColor;
            ctx.lineWidth = 3;
            ctx.stroke();

            // Central star (retirement goal) with risk-based gradient
            const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, 30);
            if (riskProfile === 'conservative') {
                gradient.addColorStop(0, '#00ff88');
                gradient.addColorStop(1, '#00d4ff');
            } else if (riskProfile === 'aggressive') {
                gradient.addColorStop(0, '#ff4444');
                gradient.addColorStop(1, '#ff6b35');
            } else {
                gradient.addColorStop(0, '#ffd700');
                gradient.addColorStop(1, '#ff6b35');
            }
            
            ctx.beginPath();
            ctx.arc(centerX, centerY, 20, 0, Math.PI * 2);
            ctx.fillStyle = gradient;
            ctx.fill();
            ctx.shadowBlur = 30;
            ctx.shadowColor = gradient;

            // Orbiting particles representing contribution periods
            const years = data.p50 ? 30 : 20; // Estimate
            for (let i = 0; i < years; i++) {
                const angle = (i / years) * Math.PI * 2;
                const radius = maxRadius * 0.8;
                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius;
                
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, Math.PI * 2);
                ctx.fillStyle = ringColor;
                ctx.fill();
            }

            // Labels
            ctx.shadowBlur = 0;
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('RETIREMENT GOAL', centerX, centerY - 40);
            
            const formatCurrency = (amount) => {
                if (amount >= 10000000) return '‚Çπ' + (amount / 10000000).toFixed(1) + 'Cr';
                else if (amount >= 100000) return '‚Çπ' + (amount / 100000).toFixed(1) + 'L';
                else return '‚Çπ' + (amount / 1000).toFixed(0) + 'K';
            };
            
            ctx.font = 'bold 24px Arial';
            ctx.fillText(formatCurrency(data.p50), centerX, centerY + 10);
        }

        function drawProbabilityChart(existingResults, optimizedResults) {
            const ctx = document.getElementById('probabilityChart').getContext('2d');
            
            // Create histogram for both scenarios
            const bins = 20;
            const allResults = [...existingResults, ...optimizedResults];
            const min = Math.min(...allResults);
            const max = Math.max(...allResults);
            const binSize = (max - min) / bins;
            
            const existingHistogram = new Array(bins).fill(0);
            const optimizedHistogram = new Array(bins).fill(0);
            
            existingResults.forEach(result => {
                const bin = Math.min(Math.floor((result - min) / binSize), bins - 1);
                existingHistogram[bin]++;
            });
            
            optimizedResults.forEach(result => {
                const bin = Math.min(Math.floor((result - min) / binSize), bins - 1);
                optimizedHistogram[bin]++;
            });

            const labels = [];
            for (let i = 0; i < bins; i++) {
                const value = min + (i + 0.5) * binSize;
                if (value >= 10000000) {
                    labels.push((value / 10000000).toFixed(1) + 'Cr');
                } else if (value >= 100000) {
                    labels.push((value / 100000).toFixed(0) + 'L');
                } else {
                    labels.push((value / 1000).toFixed(0) + 'K');
                }
            }

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Existing Strategy',
                            data: existingHistogram,
                            backgroundColor: 'rgba(255, 170, 0, 0.5)',
                            borderColor: 'rgba(255, 170, 0, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Optimized Strategy',
                            data: optimizedHistogram,
                            backgroundColor: 'rgba(0, 255, 136, 0.5)',
                            borderColor: 'rgba(0, 255, 136, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#ffffff'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#ffffff',
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Scenario Comparison: 1,000 Monte Carlo Simulations Each',
                            color: '#ffffff',
                            font: {
                                size: 16
                            }
                        }
                    }
                }
            });
        }

        function drawAssetAllocationChart(assetAllocation) {
            const ctx = document.getElementById('assetAllocationChart').getContext('2d');
            
            const ages = assetAllocation.map(a => a.age);
            const equity = assetAllocation.map(a => a.equity);
            const debt = assetAllocation.map(a => a.debt);
            const alternative = assetAllocation.map(a => a.alternative);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ages,
                    datasets: [
                        {
                            label: 'Equity (%)',
                            data: equity,
                            borderColor: 'rgba(255, 68, 68, 1)',
                            backgroundColor: 'rgba(255, 68, 68, 0.2)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Debt (%)',
                            data: debt,
                            borderColor: 'rgba(0, 212, 255, 1)',
                            backgroundColor: 'rgba(0, 212, 255, 0.2)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Alternative (%)',
                            data: alternative,
                            borderColor: 'rgba(255, 215, 0, 1)',
                            backgroundColor: 'rgba(255, 215, 0, 0.2)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#ffffff',
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#ffffff'
                            },
                            title: {
                                display: true,
                                text: 'Age',
                                color: '#ffffff'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Automatic Risk Reduction as You Age (Glide Path)',
                            color: '#ffffff',
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Auto-update theme based on age
        document.getElementById('currentAge').addEventListener('input', function() {
            const age = parseInt(this.value);
            let stage = 'young';
            if (age > 30 && age <= 45) stage = 'mid';
            else if (age > 45) stage = 'mature';
            
            document.querySelectorAll('.stage-card').forEach(c => c.classList.remove('active'));
            document.querySelector(`[data-stage="${stage}"]`).classList.add('active');
            updateTheme(stage);
        });
    </script>
</body>
</html>
